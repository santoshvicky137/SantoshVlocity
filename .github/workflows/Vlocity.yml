name: ğŸš€ Vlocity Deploy Job

on:
  push:
    branches:
      - VL-QA
  workflow_dispatch:
    inputs:
      environment:
        description: 'ğŸ¯ Target Environment'
        required: true
        default: 'VL-UAT'
        type: choice
        options:
          - VL-UAT
          - VL-Release

env:
  API_VERSION: '63.0'
  ORG_ALIAS: 'target-org'
  FALLBACK_DEPTH: '3'

jobs:
  qa-deploy:
    if: github.ref == 'refs/heads/VL-QA'
    runs-on: ubuntu-latest
    container:
      image: vlenergy/salesforcevlocity:v4.0
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ğŸ§¹ Ensure full history for delta comparison

      - name: ğŸ” Mark workspace safe for Git
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: ğŸ”§ Make Scripts Executable
        run: chmod +x CIScripts/*.sh  # ğŸ› ï¸ Ensure shell scripts are runnable

      - name: ğŸ”‘ Authenticate to Salesforce Org
        run: |
          echo "${{ secrets.SFDX_AUTH_URL_VL_QA }}" > auth-url.txt
          sf org login sfdx-url --sfdx-url-file auth-url.txt --alias ${{ env.ORG_ALIAS }} --set-default
        # ğŸ” Login using SFDX auth URL for VL-QA
          
      - name: ğŸ“¦ Generate Delta Package
        run: bash CIScripts/vlocity-delta.sh
        env:
          ENVIRONMENT: VL-QA
          FALLBACK_DEPTH: ${{ env.FALLBACK_DEPTH }
        # ğŸ“Š Create delta package based on recent changes  
        
      - name: ğŸ“ Check for job.yaml
        shell: bash
        run: |
          if [[ ! -f job.yaml ]]; then
             echo "âŒ job.yaml not found!"
             exit 1
          fi
        # ğŸ§¾ Ensure job.yaml exists before deploying


      - name: ğŸš€ Deploy Delta to VL-QA
        if: env.skip_deploy != 'true'
        run: |
          vlocity -sfdx.username "${{ env.ORG_ALIAS }}" -job job.yaml packDeploy --verbose
       # ğŸšš Deploy selected datapacks to VL-QA
       
      - name: ğŸ“ Update SHA in Org
        shell: bash
        if: success()
        run: |
          COMMIT_SHA=$(git rev-parse HEAD)
          CMDT_RECORD_ID=$(sfdx force:data:soql:query \
            -q "SELECT Id FROM VlocitySHA__c LIMIT 1" \
            -u "${{ env.ORG_ALIAS }}" \
            --json | jq -r '.result.records[0].Id')
          if [[ -n "$CMDT_RECORD_ID" && "$CMDT_RECORD_ID" != "null" ]]; then
            sf force data record update \
              -s "VlocitySHA__c" \
              -i "$CMDT_RECORD_ID" \
              -o "${{ env.ORG_ALIAS }}" \
              -v "vlocitylastsha__c='${COMMIT_SHA}'"
          fi
      # ğŸ§¾ Record latest commit SHA in org for traceability
      
      - name: ğŸ§¹ Cleanup
        if: always()
        run: rm -rf delta/
      # ğŸ§¼ Remove temporary delta folder
      
  manual-deploy:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    container:
      image: vlenergy/salesforcevlocity:v4.0
    env:
      ENVIRONMENT: ${{ github.event.inputs.environment }}
      ORG_ALIAS: 'target-org'
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ğŸ§¹ Ensure full history for delta comparison

      - name: ğŸ” Mark workspace safe for Git
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: ğŸ”§ Make Scripts Executable
        run: chmod +x CIScripts/*.sh  # ğŸ› ï¸ Ensure shell scripts are runnable

      - name: ğŸ”‘ Authenticate to Target Org
        shell: bash
        run: |
          if [[ "${{ env.ENVIRONMENT }}" == "VL-UAT" ]]; then
            sf org login sfdx-url --sfdx-url-file <(echo "${{ secrets.SFDX_AUTH_URL_VL_UAT }}") --alias ${{ env.ORG_ALIAS }} --set-default
          elif [[ "${{ env.ENVIRONMENT }}" == "VL-Release" ]]; then
            sf org login sfdx-url --sfdx-url-file <(echo "${{ secrets.SFDX_AUTH_URL_VL_RELEASE }}") --alias ${{ env.ORG_ALIAS }} --set-default
          else
            echo "âŒ Unknown environment: ${{ env.ENVIRONMENT }}. Aborting."
            exit 1
          fi
        # ğŸ” Login to correct org based on selected environment

      - name: ğŸ“¦ Generate Delta Package
        run: bash CIScripts/vlocity-delta.sh
        env:
          ENVIRONMENT: ${{ env.ENVIRONMENT }}
          FALLBACK_DEPTH: ${{ env.FALLBACK_DEPTH }}
        # ğŸ“Š Create delta package based on recent changes

      - name: ğŸ“ Check for job.yaml
        shell: bash
        run: |
          if [[ ! -f job.yaml ]]; then
             echo "âŒ job.yaml not found!"
             exit 1
          fi
        # ğŸ§¾ Ensure job.yaml exists before deploying

      - name: Check for job.yaml
        shell: bash
        run: |
          if [[ ! -f job.yaml ]]; then
             echo "âŒ job.yaml not found!"
             exit 1
            fi

      - name: ğŸš€ Deploy Delta to Org
        if: env.skip_deploy != 'true'
        run: |
          vlocity -sfdx.username "${{ env.ORG_ALIAS }}" -job job.yaml packDeploy --verbose
        # ğŸšš Deploy selected datapacks to target org

      - name: ğŸ“ Update SHA in Org
        if: success()
        shell: bash
        run: |
          COMMIT_SHA=$(git rev-parse HEAD)
          CMDT_RECORD_ID=$(sfdx force:data:soql:query \
            -q "SELECT Id FROM VlocitySHA__c LIMIT 1" \
            -u "${{ env.ORG_ALIAS }}" \
            --json | jq -r '.result.records[0].Id')
          if [[ -n "$CMDT_RECORD_ID" && "$CMDT_RECORD_ID" != "null" ]]; then
            sf force data record update \
              -s "VlocitySHA__c" \
              -i "$CMDT_RECORD_ID" \
              -o "${{ env.ORG_ALIAS }}" \
              -v "vlocitylastsha__c='${COMMIT_SHA}'"
          fi
        # ğŸ§¾ Record latest commit SHA in org for traceability

      - name: ğŸ§¹ Cleanup
        if: always()
        run: rm -rf delta/
        # ğŸ§¼ Remove temporary delta folder
